- name: create docker group
  group: name=docker system=yes

- name: create user
  action: user
  args: vexor_worker.user

- name: checkout repo
  action: git
  args: vexor_worker.repo
  register: result

- name: change owner of repo
  file: dest={{ vexor_worker_home }} owner={{ vexor_worker.user.name }} recurse=yes
  when: result | changed

- name: run bundler
  shell: >
    {{ vexor_common_bundle_install }} chdir={{ vexor_worker_home }}
  when: result | changed
  sudo: true
  sudo_user: "{{ vexor_worker.user.name }}"

- name: create directories
  file: >
    path={{ item }} state=directory owner={{ vexor_worker.user.name }}
  with_items:
    -  "/etc/vexor"

- name: create files
  template: >
    dest={{ item.dest }} src={{ item.src }} owner={{ vexor_worker.user.name }} mode={{ item.mode }}
  with_items:
    - { dest: "/etc/vexor/ci", src: "env.j2", mode: "0640" }
    - { dest: "/etc/init/vx-worker.conf", src: "upstart.j2", mode: "0755" }
