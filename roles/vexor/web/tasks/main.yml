- name: create user
  user: >
    name={{ vx_user }} comment="Vexor Web Worker"
    createhome=false system=true home={{ vx_home }}/web

- name: create postgresql database
  sudo_user: postgres
  postgresql_db: >
    name={{ vx_db_name }}
    encoding='UTF-8'
    login_host=/var/run/postgresql
  register: create_db_result

- name: create hstore extension in postgresql
  sudo_user: postgres
  shell: psql {{ vx_db_name }} -c "CREATE EXTENSION IF NOT EXISTS hstore;"
  when: create_db_result | changed

- name: create postgresql user
  sudo_user: postgres
  postgresql_user: >
    db={{ vx_db_name }}
    name={{ vx_user }}
    password={{ vx_db_password }}
    priv=ALL
    login_host=/var/run/postgresql

- name: install required packages
  apt: pkg={{ item }}
  with_items:
    - "vx-embeded-ruby-2.0"
    - "vx-embeded-bundler-2.0"
    - "nodejs"

- name: create working directories
  file: dest={{ item }} state=directory owner={{ vx_user }}
  with_items:
    - "{{ vx_etc_path }}"
    - "{{ vx_home }}/web"
    - "{{ vx_home }}/web/releases"

- name: create files
  template: >
    dest={{ item.dest }} src={{ item.src }}
    owner={{ vx_user }} mode={{ item.mode }}
  with_items:
    - { dest: "{{ vx_etc_path}}/ci", src: "env.j2", mode: "0640" }
    - { dest: "{{ vx_home }}/web/deploy.rb", src: "deploy.rb", mode: "0644" }
  register: create_result

- name: clone repo
  sudo_user: "{{ vx_user }}"
  git: >
    repo="https://github.com/vexor/vx-web.git"
    dest={{ vx_home }}/web/scm version={{ vx_version }}
    update=true force=true bare=true
  register: clone_result

- name: generate deploy script
  shell: >
    force_assets=1 force_migrate=1 {{ vx_mina }} -S -f {{ vx_home }}/web/deploy.rb deploy | grep -v 'Elapsed' > {{ vx_home }}/web/up
  sudo_user: "{{ vx_user }}"
  when: clone_result | changed or create_result | changed
  register: script_result

- name: run deploy script
  shell: >
    bash {{ vx_home }}/web/up > {{ vx_home }}/web/up.log
  sudo_user: "{{ vx_user }}"
  when: script_result | changed

